
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Upload</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="vh-100 d-flex justify-content-center align-items-center">
        <div class="card">
            <div class="card-header">
              AI Detection Service
            </div>
            <div class="card-body">
              <h5 class="card-title">File Upload
                <span>&nbsp;</span>
                <span class="spinner-border spinner-border-sm text-success invisible" id="status"></span>
                <span><small class="text-muted" id="fileCountStatus"></small></span>
              </h5>
              <p class="card-text">Upload an excel file to get predictions for a series of documents.</p>
              <form class="input-group" id="uploadForm">
                <input type="file" class="form-control" id="fileInput" multiple>
                <button class="btn btn-outline-secondary" type="submit">Upload</button>
              </form>
            </div>
            <div>
                <ul class="list-group list-group-flush" id="fileList">
                    <!-- <li class="list-group-item"><span>Title.md</span><button class="btn btn-sm btn-success float-end">Download</button></li>
                    <li class="list-group-item"><span>Title.md</span><button class="btn btn-sm btn-success float-end" id="btn">Download</button></li> -->
                </ul>
                
            </div>
        </div>
    </div>
    <script>

        function uuidv4() {
            return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
                (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
            );
        }

        const fileCountStatus = $('#fileCountStatus');
        const status = $('#status');

        $('#uploadForm').on('submit', function (e) {
            e.preventDefault();
            // update status
            status.removeClass('invisible');
            
            const files = $('#fileInput')[0].files;
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const sessionId = uuidv4();
                    uploadFileInChunks(files[i], sessionId);
                    fileCountStatus.text(`${i+1}/${files.length}`)
                }
            }
            // update status
            status.addClass('invisible');
            
        });

        function uploadFileInChunks(file, sessionId) {
            const chunkSize = 1 * 1024 * 1024; // 1MB
            const totalChunks = Math.ceil(file.size / chunkSize);
            let currentChunk = 0;

            function readAndUploadNextChunk() {
                const start = currentChunk * chunkSize;
                const end = Math.min(start + chunkSize, file.size);
                const blob = file.slice(start, end);
                const reader = new FileReader();

                reader.onload = function (e) {
                    const formData = new FormData();
                    formData.append('file', new Blob([e.target.result], { type: file.type }), file.name);
                    formData.append('chunk', currentChunk);
                    formData.append('total_chunks', totalChunks);
                    formData.append('session_id', sessionId);

                    $.ajax({
                        url: '/upload',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function () {
                            console.log(`Chunk ${currentChunk} of ${file.name} uploaded`);
                            if (currentChunk === totalChunks - 1) {
                                // All chunks uploaded, now wait for processing completion
                                pollForProcessingStatus(sessionId, file.name);
                            } else {
                                currentChunk++;
                                readAndUploadNextChunk();
                            }
                    },
                    error: function (xhr, status, error) {
                            console.error(`Error uploading chunk ${currentChunk} of ${file.name}: ${error}`);
                        }
                    });
                };

                reader.onerror = function () {
                    console.error(`Error reading chunk ${currentChunk} of ${file.name}`);
                };

                reader.readAsArrayBuffer(blob);
            }

            readAndUploadNextChunk();
        }

        function pollForProcessingStatus(sessionId, fileName) {
            const statusUpdateInterval = setInterval(function () {
                $.get(`/processing-status?session_id=${sessionId}`)
                    .done(function (response) {
                        if (response.status === 'done') {
                            clearInterval(statusUpdateInterval);
                            updateFileListItem(fileName, sessionId, true);
                        } else if (response.status === 'processing') {
                            updateFileListItem(fileName, sessionId, false);
                        } else {
                            clearInterval(statusUpdateInterval);
                            console.error(`Unexpected status: ${response.status}`);
                        }
                    })
                    .fail(function (xhr, status, error) {
                        console.error(`Error polling processing status for ${fileName}: ${error}`);
                        clearInterval(statusUpdateInterval);
                    });
            }, 2000); // Poll every 2 seconds (adjust as needed)
        }

        function updateFileListItem(fileName, sessionId, isDone) {
            // <li class="list-group-item"><span>Title.md</span><button class="btn btn-sm btn-success float-end">Download</button></li>
            const listItem = $(`<li class="list-group-item"><span>${fileName}</span></li>`);
            const spinner = $(`<span class="spinner-border spinner-border-sm text-success" id="spinner-${sessionId}"></span>`)
            const button = $(`<button class="btn btn-sm btn-primary float-end">Download</button>`);
            button.on('click', function () { downloadFile(sessionId); });
            if (isDone) {
                spinner.addClass("invisible");
            } else {
                button.removeClass("disabled")
            }
            listItem.append(spinner);
            listItem.append(button);
            console.log(listItem);
            $('#fileList').append(listItem);
        }

        function downloadFile(sessionId) {
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = `/download-file?session_id=${sessionId}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

    </script>
</body>
</html>

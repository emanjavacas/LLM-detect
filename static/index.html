
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Upload</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanjs@latest"></script>
</head>
<body>
    <div class="vh-100 d-flex justify-content-center align-items-center">
        <div class="card">
            <div class="card-header">
              AI Detection Service
            </div>
            <div class="card-body">
              <h5 class="card-title">File Upload</h5>
              <p class="card-text">Upload an excel file to get predictions for a series of documents.</p>
              <form class="input-group" id="uploadForm">
                <input type="file" class="form-control" id="fileInput" multiple>
                <button class="btn btn-outline-secondary" type="submit">Upload</button>
              </form>
            </div>
            <div>
                <ul class="list-group list-group-flush" id="fileList">
                    <!-- <li class="list-group-item">
                        <span>Title.md</span>
                        <button class="btn btn-sm btn-success float-end">Download</button>
                        <div><span class="badge bg-info text-dark">Uploading...</span></div>
                    </li>
                    <li class="list-group-item"><span>Title.md</span><button class="btn btn-sm btn-success float-end" id="btn">Download</button></li> -->
                </ul>                
            </div>
        </div>
    </div>
    <script>
        // const { h, reactive, mount}
        $(document).ready(function() {
            function trimFilename(fname, length) {
                if (fname.length > length)  {
                    return fname.substring(0, length-3) + "...";
                } else {
                    return fname;
                }
            }

            function uuidv4() {
                return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
                    (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
                );
            }

            function createListItem(fileName, sessionId) {
                const listItem = $(`<li class="list-group-item"><span>${fileName}</span>`);
                const button = $(`<button id="btn-${sessionId}" class="btn btn-sm btn-primary float-end disabled">Download</button>`);
                const status = $(`<div><span id="status-${sessionId}" class="badge bg-warning text-dark">Uploading...</span></div>`);
                button.on('click', function() {downloadFile(sessionId);})
                listItem.append(button);
                listItem.append(status);
                return listItem;
            }
                    
            function downloadFile(sessionId) {
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = `/download-file?session_id=${sessionId}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }

            $('#uploadForm').on('submit', function (e) {
                e.preventDefault();                
                const files = $('#fileInput')[0].files;
                if (files.length > 0) {
                    for (let i = 0; i < files.length; i++) {
                        const sessionId = uuidv4();
                        // add list item
                        const listItem = createListItem(files[i].name, sessionId);
                        $('#fileList').append(listItem);
                        // create WebSocket
                        const ws = new WebSocket(`ws://${window.location.host}/ws/${sessionId}`);
                        ws.onmessage = function(e) {
                            const data = JSON.parse(e.data);
                            if (data.status == "done") {
                                console.log("File ready for download");
                                // enable button
                                $(`#btn-${sessionId}`).removeClass("disabled");
                                // change status to ready
                                const status = $(`#status-${sessionId}`);
                                status.text("Ready to download.")
                                status.removeClass("bg-info").addClass("bg-success");
                            }
                        }
                        // upload
                        uploadFileInChunks(files[i], sessionId);
                    }
                }
                // clear input field
                $('#fileInput').val('');
            });

            function uploadFileInChunks(file, sessionId) {
                const chunkSize = 1 * 1024 * 1024; // 1MB
                const totalChunks = Math.ceil(file.size / chunkSize);
                let currentChunk = 0;

                function readAndUploadNextChunk() {
                    const start = currentChunk * chunkSize;
                    const end = Math.min(start + chunkSize, file.size);
                    const blob = file.slice(start, end);

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const formData = new FormData();
                        formData.append('file', new Blob([e.target.result], { type: file.type }), file.name);
                        formData.append('chunk', currentChunk);
                        formData.append('total_chunks', totalChunks);
                        formData.append('session_id', sessionId);
                        $.ajax({
                            url: '/upload',
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            success: function () {
                                console.log(`Chunk ${currentChunk} of ${file.name} uploaded`);
                                if (currentChunk === totalChunks - 1) {
                                    // file started processing. Update status and wait
                                    const status = $(`#status-${sessionId}`);
                                    status.text("Processing...")
                                    status.removeClass("bg-warning").addClass("bg-info");
                                } else {
                                    currentChunk++;
                                    readAndUploadNextChunk();
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error(`Error uploading chunk ${currentChunk} of ${file.name}: ${error}`);
                            }
                        });
                    }
                    reader.onerror = function () {
                        console.error(`Error reading chunk ${currentChunk} of ${file.name}`);
                    }
                    reader.readAsArrayBuffer(blob);
                } 
                readAndUploadNextChunk();
            } // uploadFileInChunks
        });
    </script>
</body>
</html>
